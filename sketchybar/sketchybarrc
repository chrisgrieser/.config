#!/usr/bin/env zsh
#───────────────────────────────────────────────────────────────────────────────

# CONFIG
plugin_dir="$(dirname "$0")" # plugins in same folder as this rc-file

# open Stats
i=0
while ! pgrep -xq "Stats"; do
	open -a "Stats"
	sleep 2
	i=$((i + 1))
	[[ $i -gt 4 ]] && break
done

# switch colors depending on dark mode
if defaults read -g AppleInterfaceStyle | grep -q "Dark"; then
	bg_color="0xff333333"
	font_color="0xffffffff"
else
	bg_color="0xffcdcdcd"
	font_color="0xff000000"
fi

first_row="left"
# HACK using popup for second row. The popup.{item} only refers to {item} to
# anchor to it. Should be the leftmost item.
second_row="popup.clock"

nerd_font="JetBrainsMonoNL NF"
system_font="Lucida Grande"

# PENDING
# alias.cutoff https://github.com/FelixKratz/SketchyBar/issues/575

#───────────────────────────────────────────────────────────────────────────────
# SKETCHYBAR CALL

# one big call to speed up reloading https://felixkratz.github.io/SketchyBar/config/tricks#batching-of-configuration-commands
sketchybar \
	--bar \
	height=60 position="top" display="all" \
	padding_left=0 margin=-5 color="$bg_color" \
	\
	--default \
	icon.font="${nerd_font}:Bold:16" icon.color="$font_color" icon.padding_right=3 \
	label.font="${system_font}:Regular:16.5" label.color="$font_color" \
	background.padding_right=10 label.padding_right=2 \
	popup.drawing=true popup.horizontal=true popup.topmost=false \
	popup.y_offset="-35" y_offset="18" popup.padding_left=20 \
	\
	`#─────────────────────────────────────────────────────────────────────────` \
	\
	--add item clock $first_row \
	--set clock update_freq=1 background.padding_left=10 \
	script="$plugin_dir/clock.sh" \
	\
	--add alias "BusyCal Menu" $first_row \
	--set "BusyCal Menu" padding_right=0 padding_left=-15 y_offset=17 \
	\
	--add item weather $first_row \
	--set weather update_freq=1200 icon.y_offset=-1 drawing=false \
	script="$plugin_dir/weather.sh" \
	\
	--add item github_notif $first_row \
	--set github_notif update_freq=300 icon="" drawing=false \
	script="$plugin_dir/github_notification_count.sh" \
	--subscribe github_notif front_app_switched \
	--subscribe github_notif system_woke \
	\
	--add item reminders_count $first_row \
	--set reminders_count update_freq=3600 icon=" " drawing=false \
	script="$plugin_dir/reminders-count.sh" \
	--subscribe reminders_count front_app_switched \
	--subscribe reminders_count system_woke \
	--add event update_reminder_count \
	--subscribe reminders_count update_reminder_count \
	\
	`#─────────────────────────────────────────────────────────────────────────` \
	\
	--add alias "Stats,CombinedModules" "$second_row" \
	--set "Stats,CombinedModules" padding_right=-20 \
	\
	--add item sync-indicator "$second_row" \
	--set sync-indicator update_freq=300 icon="" drawing=false \
	script="$plugin_dir/git-sync-bar-icon.sh" \
	--add event repo-files-update \
	--subscribe sync-indicator repo-files-update \
	--subscribe sync-indicator system_woke \
	\
	--add item package-updates "$second_row" \
	--set package-updates update_freq=86400 icon="" drawing=false \
	script="$plugin_dir/homebrew-update-tracker.sh" \
	\
	`#─────────────────────────────────────────────────────────────────────────` \
	--update # needs to run at the end of config and should not be run in an item script
