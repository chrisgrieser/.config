# yaml-language-server: $schema=./schema/karabiner-mod-schema.json
title: Vim Mode for 'Easy CSV Editor.app'
anchors:
  - conditions:
      - &insert-mode { type: variable_if, name: CSV_EDITOR_INSERT_MODE, value: true }
      - &normal-mode { type: variable_unless, name: CSV_EDITOR_INSERT_MODE, value: true }
      - &is-csv-editor
        type: frontmost_application_if
        bundle_identifiers: [com.vladbadea.csveditor]
      - &german-keyboard { type: input_source_if, input_sources: [language: ^de$] }
      - &not-german-keyboard { type: input_source_unless, input_sources: [language: ^de$] }
  - to:
      - &enter-normal-mode { set_variable: { name: CSV_EDITOR_INSERT_MODE, value: false } }
      - &enter-insert-mode { set_variable: { name: CSV_EDITOR_INSERT_MODE, value: true } }
      - &remove-notice { set_notification_message: { id: csv-editor-vim-notice, text: "" } }
      - &set-notice
        set_notification_message: { id: csv-editor-vim-notice, text: ✏️ CSV Editor Insert Mode }
#───────────────────────────────────────────────────────────────────────────────
rules:
  - description: "✏️ CSV Editor Vim Mode: Triggers/Toggles"
    manipulators:
      # ENTER NORMAL/INSERT MODE
      - type: basic
        from: { key_code: caps_lock }
        to_if_alone: [*remove-notice, *enter-normal-mode, { key_code: escape }]
        to: [{ key_code: right_command, modifiers: [control, option] }] # preserve hyper key
        conditions: [*is-csv-editor, *insert-mode]
      - type: basic
        from: { key_code: escape }
        to: [*remove-notice, *enter-normal-mode, { key_code: escape }]
        conditions: [*is-csv-editor, *insert-mode]
      # leave insert mode when quitting
      - type: basic
        from: { key_code: q, modifiers: { mandatory: [command] } }
        to:
          - { key_code: s, modifiers: [command] } # save before quitting
          - { key_code: vk_none, hold_down_milliseconds: 200 }
          - { key_code: q, modifiers: [command] }
          - *remove-notice
          - *enter-normal-mode
        conditions: [*is-csv-editor]
      - type: basic
        from: { key_code: w, modifiers: { mandatory: [command] } }
        to:
          - { key_code: w, modifiers: [command] }
          - *remove-notice
          - *enter-normal-mode
        conditions: [*is-csv-editor, *insert-mode]

      - type: basic
        from: { key_code: return_or_enter }
        to: [*set-notice, *enter-insert-mode, { key_code: return_or_enter }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: return_or_enter }
        to: [*remove-notice, *enter-normal-mode, { key_code: return_or_enter }]
        conditions: [*is-csv-editor, *insert-mode]
      - type: basic
        from: { key_code: tab }
        to: [*remove-notice, *enter-normal-mode, { key_code: tab }]
        conditions: [*is-csv-editor, *insert-mode]
  #─────────────────────────────────────────────────────────────────────────────
    # cmd+enter: enter table, when no cell is focussed
      - type: basic
        from: { key_code: return_or_enter, modifiers: { mandatory: [command] } }
        to:
          # HACK select all, and move down = goes to first cell
          - { key_code: a, modifiers: [command] }
          - { key_code: down_arrow }
        conditions: [*is-csv-editor]
  #─────────────────────────────────────────────────────────────────────────────
  - description: "✏️ CSV Editor Vim Mode: Actions"
    manipulators:
      # j/k: cell up/down
      - type: basic
        from: { key_code: j }
        to: [{ key_code: down_arrow }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: k }
        to: [{ key_code: up_arrow }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: j, modifiers: { mandatory: [shift] } }
        to: # 6x down
          - key_code: down_arrow
          - key_code: down_arrow
          - key_code: down_arrow
          - key_code: down_arrow
          - key_code: down_arrow
          - key_code: down_arrow
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: k, modifiers: { mandatory: [shift] } }
        to: # 6x up
          - key_code: up_arrow
          - key_code: up_arrow
          - key_code: up_arrow
          - key_code: up_arrow
          - key_code: up_arrow
          - key_code: up_arrow
        conditions: [*is-csv-editor, *normal-mode]
      # g/G fully down/up
      - type: basic
        from: { key_code: g }
        to: [{ key_code: up_arrow, modifiers: [command] }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: g, modifiers: { mandatory: [shift] } }
        to: [{ key_code: down_arrow, modifiers: [command] }]
        conditions: [*is-csv-editor, *normal-mode]
      # h/l cell left/right
      - type: basic
        from: { key_code: h }
        to: [{ key_code: left_arrow }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: l }
        to: [{ key_code: right_arrow }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: h, modifiers: { mandatory: [shift] } }
        to: [{ key_code: left_arrow, modifiers: [command] }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: l, modifiers: { mandatory: [shift] } }
        to: [{ key_code: right_arrow, modifiers: [command] }]
        conditions: [*is-csv-editor, *normal-mode]
      # o/O open row above/below
      - type: basic
        from: { key_code: o }
        to:
          - { key_code: down_arrow, modifiers: [option] }
          - { key_code: return_or_enter }
          - *enter-insert-mode
          - *set-notice
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: o, modifiers: { mandatory: [shift] } }
        to:
          - { key_code: up_arrow, modifiers: [option] }
          - { key_code: return_or_enter }
          - *enter-insert-mode
          - *set-notice
        conditions: [*is-csv-editor, *normal-mode]
      # c/C open column after/before
      - type: basic
        from: { key_code: c }
        to:
          - { key_code: right_arrow, modifiers: [option] }
          - { key_code: return_or_enter }
          - *enter-insert-mode
          - *set-notice
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: c, modifiers: { mandatory: [shift] } }
        to:
          - { key_code: left_arrow, modifiers: [option] }
          - { key_code: return_or_enter }
          - *enter-insert-mode
          - *set-notice
        conditions: [*is-csv-editor, *normal-mode]
      # d/D: delete row/column
      - type: basic
        from: { key_code: d }
        to: [{ key_code: x, modifiers: [command, shift] }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: d, modifiers: { mandatory: [shift] } }
        to: [{ key_code: z, modifiers: [command, shift] }] # z and y switched on German keyboard
        conditions: [*is-csv-editor, *normal-mode, *german-keyboard]
      - type: basic
        from: { key_code: d, modifiers: { mandatory: [shift] } }
        to: [{ key_code: y, modifiers: [command, shift] }]
        conditions: [*is-csv-editor, *normal-mode, *not-german-keyboard]
      # -/: Search
      - type: basic
        from: { key_code: slash }
        to:
          - { key_code: f, modifiers: [command] }
          - *enter-insert-mode
          - *set-notice
        conditions: [*is-csv-editor, *normal-mode]
      # w/W: duplicate row/column
      - type: basic
        from: { key_code: w }
        to: [{ key_code: d, modifiers: [command, shift] }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: w, modifiers: { mandatory: [shift] } }
        to: [{ key_code: c, modifiers: [command, shift] }]
        conditions: [*is-csv-editor, *normal-mode]
      # m/M: move ROW up/down
      - type: basic
        from: { key_code: m }
        to: [{ key_code: down_arrow, modifiers: [option, shift] }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: m, modifiers: { mandatory: [shift] } }
        to: [{ key_code: up_arrow, modifiers: [option, shift] }]
        conditions: [*is-csv-editor, *normal-mode]
      # n/N: move COLUMN right/left
      - type: basic
        from: { key_code: n }
        to: [{ key_code: right_arrow, modifiers: [option, shift] }]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: n, modifiers: { mandatory: [shift] } }
        to: [{ key_code: left_arrow, modifiers: [option, shift] }]
        conditions: [*is-csv-editor, *normal-mode]
      # y/Y: yank row/column
      - type: basic
        from: { key_code: z } # z and y switched on German keyboard
        to:
          - { key_code: left_arrow, modifiers: [command] }
          - { key_code: right_arrow, modifiers: [command, shift] }
          - { key_code: c, modifiers: [command] }
        conditions: [*is-csv-editor, *normal-mode, *german-keyboard]
      - type: basic
        from: { key_code: z, modifiers: { mandatory: [shift] } } # z and y switched on German keyboard
        to:
          - { key_code: up_arrow, modifiers: [command] }
          - { key_code: down_arrow, modifiers: [command, shift] }
          - { key_code: c, modifiers: [command] }
        conditions: [*is-csv-editor, *normal-mode, *german-keyboard]
      - type: basic
        from: { key_code: "y" }
        to:
          - { key_code: left_arrow, modifiers: [command] }
          - { key_code: right_arrow, modifiers: [command, shift] }
          - { key_code: c, modifiers: [command] }
        conditions: [*is-csv-editor, *normal-mode, *not-german-keyboard]
      - type: basic
        from: { key_code: "y", modifiers: { mandatory: [shift] } }
        to:
          - { key_code: up_arrow, modifiers: [command] }
          - { key_code: down_arrow, modifiers: [command, shift] }
          - { key_code: c, modifiers: [command] }
        conditions: [*is-csv-editor, *normal-mode, *not-german-keyboard]
      # p/P: paste below/above
      - type: basic
        from: { key_code: p }
        to:
          - shell_command: |
              osascript -e '
                tell application "System Events" to tell process "Easy CSV Editor"
                  click menu item "Insert Copied Rows Below" of menu "Table" of menu bar 1
                end tell'
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: p, modifiers: { mandatory: [shift] } }
        to:
          - shell_command: |
              osascript -e '
                tell application "System Events" to tell process "Easy CSV Editor"
                  click menu item "Insert Copied Columns After" of menu "Table" of menu bar 1
                end tell'
        conditions: [*is-csv-editor, *normal-mode]
      # u/U: undo/redo
      - type: basic
        from: { key_code: u }
        to: [{ key_code: "y", modifiers: [command] }] # z and y switched on German keyboard
        conditions: [*is-csv-editor, *normal-mode, *german-keyboard]
      - type: basic
        from: { key_code: u, modifiers: { mandatory: [shift] } }
        to: [{ key_code: "y", modifiers: [command, shift] }] # z and y switched on German keyboard
        conditions: [*is-csv-editor, *normal-mode, *german-keyboard]
      - type: basic
        from: { key_code: u }
        to: [{ key_code: z, modifiers: [command] }]
        conditions: [*is-csv-editor, *normal-mode, *not-german-keyboard]
      - type: basic
        from: { key_code: u, modifiers: { mandatory: [shift] } }
        to: [{ key_code: z, modifiers: [command, shift] }]
        conditions: [*is-csv-editor, *normal-mode, *not-german-keyboard]
        #───────────────────────────────────────────────────────────────────────
      # numbers: enter insert mode and press number
      - type: basic
        from: { key_code: "0" }
        to: [{ key_code: "0" }, *enter-insert-mode, *set-notice]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: "1" }
        to: [{ key_code: "1" }, *enter-insert-mode, *set-notice]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: "2" }
        to: [{ key_code: "2" }, *enter-insert-mode, *set-notice]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: "3" }
        to: [{ key_code: "3" }, *enter-insert-mode, *set-notice]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: "4" }
        to: [{ key_code: "4" }, *enter-insert-mode, *set-notice]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: "5" }
        to: [{ key_code: "5" }, *enter-insert-mode, *set-notice]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: "6" }
        to: [{ key_code: "6" }, *enter-insert-mode, *set-notice]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: "7" }
        to: [{ key_code: "7" }, *enter-insert-mode, *set-notice]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: "8" }
        to: [{ key_code: "8" }, *enter-insert-mode, *set-notice]
        conditions: [*is-csv-editor, *normal-mode]
      - type: basic
        from: { key_code: "9" }
        to: [{ key_code: "9" }, *enter-insert-mode, *set-notice]
        conditions: [*is-csv-editor, *normal-mode]
