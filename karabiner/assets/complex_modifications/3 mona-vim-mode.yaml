# yaml-language-server: $schema=./schema/karabiner-mod-schema.json
#───────────────────────────────────────────────────────────────────────────────
title: Mona Vim Mode
anchors:
  - conditions:
      - &is-mona { type: frontmost_application_if, bundle_identifiers: [com.jonny.supermona] }
      - &mona-insert-mode { type: variable_if, name: MONA_INSERT_MODE, value: true }
      - &mona-normal-mode { type: variable_unless, name: MONA_INSERT_MODE, value: true }
  - to:
      - &enter-normal-mode { set_variable: { name: MONA_INSERT_MODE, value: false } }
      - &enter-insert-mode { set_variable: { name: MONA_INSERT_MODE, value: true } }
      - &remove-notice { set_notification_message: { id: mona-vim-notice, text: "" } }
      - &set-notice
        set_notification_message: { id: mona-vim-notice, text: ✏️ Mona Insert Mode }
#-------------------------------------------------------------------------------
rules:
  - description: "Mona Vim Mode"
    manipulators:
      # ENTER INSERT MODE
      - type: basic # reply to tweet
        from: { key_code: r }
        to: [{ key_code: r }, *set-notice, *enter-insert-mode]
        conditions: [*is-mona, *mona-normal-mode]
      - type: basic # new tweet
        from: { key_code: n, modifiers: { mandatory: [command] } }
        to: [{ key_code: n, modifiers: [command] }, *set-notice, *enter-insert-mode]
        conditions: [*is-mona, *mona-normal-mode]
      - type: basic # confirm the new tweet
        from: { key_code: return_or_enter, modifiers: { mandatory: [command] } }
        to:
          - { key_code: return_or_enter, modifiers: [command] }
          - *remove-notice
          - *enter-normal-mode
        conditions: [*is-mona, *mona-insert-mode]
      # ENTER NORMAL MODE
      - type: basic
        from: { key_code: caps_lock }
        to_if_alone: [{ key_code: escape }, *remove-notice, *enter-normal-mode]
        to: [{ key_code: right_command, modifiers: [control, option] }] # preserve hyper key
        conditions: [*is-mona, *mona-insert-mode]
      - type: basic
        from: { key_code: escape }
        to: [{ key_code: escape }, *remove-notice, *enter-normal-mode]
        conditions: [*is-mona, *mona-insert-mode]
      # leave insert mode when quitting
      - type: basic
        from: { key_code: q, modifiers: { mandatory: [command] } }
        to:
          - { key_code: q, modifiers: [command] }
          - *remove-notice
          - *enter-normal-mode
        conditions: [*is-mona, *mona-insert-mode]
      - type: basic
        from: { key_code: w, modifiers: { mandatory: [command] } }
        to:
          - { key_code: w, modifiers: [command] }
          - *remove-notice
          - *enter-normal-mode
        conditions: [*is-mona, *mona-insert-mode]
      #-------------------------------------------------------------------------
      # `o` to open a link in the browser
      - type: basic
        from: { key_code: o }
        to:
          - { key_code: l, modifiers: [command] }
          - { key_code: vk_none, hold_down_milliseconds: 100 }
          - { key_code: down_arrow }
          - { key_code: return_or_enter }
        conditions: [*is-mona, *mona-normal-mode]
      # `O` to open a the tweet in the browser
      - type: basic
        from: { key_code: o, modifiers: { mandatory: [shift] } }
        to:
          - { key_code: o, modifiers: [command, shift] }
        conditions: [*is-mona, *mona-normal-mode]
      # `hjkl`
      - type: basic
        from: { key_code: j }
        to: [{ key_code: down_arrow }]
        conditions: [*is-mona, *mona-normal-mode]
      - type: basic
        from: { key_code: k }
        to: [{ key_code: up_arrow }]
        conditions: [*is-mona, *mona-normal-mode]
      - type: basic
        from: { key_code: h }
        to: [{ key_code: left_arrow }]
        conditions: [*is-mona, *mona-normal-mode]
      - type: basic
        from: { key_code: l }
        to: [{ key_code: right_arrow }]
        conditions: [*is-mona, *mona-normal-mode]
