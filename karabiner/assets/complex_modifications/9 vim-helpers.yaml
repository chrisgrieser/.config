title: vim helpers
rules:
  - description: "Neovide: Fix <S-Space> and cmd+q → ZZ"
    manipulators:
      - type: basic
        from: { key_code: spacebar, modifiers: { mandatory: [shift] } }
        conditions:
          - { type: frontmost_application_if, file_paths: ["[Nn]eovide"] }
        to:
          # INFO not done via Alfred because of https://github.com/neovide/neovide/issues/1604
          # INFO Quitting via :wqall instead of cmd+Q so bufferleaving autocmds are triggered
          - shell_command: |
              export PATH=/usr/local/lib:/usr/local/bin:/opt/homebrew/bin/:$PATH

              nvim --server "/tmp/nvim_server.pipe" --remote-send "<cmd>try|wqall|catch|qall|endtry<CR>"

              i=0
              while pgrep -xq "$FRONT_APP" && [[ "$i" -lt 30 ]]; do 
                i=$((i+1))
                sleep 0.05
              done

              # bwipeout necessary due to empty buffer created before jumping to '0
              nohup neovide --notabs --frame=buttonless --geometry=104x33 -- -c "execute \"normal! '0\" | bwipeout #" &
              disown # https://stackoverflow.com/a/20338584/22114136

  #─────────────────────────────────────────────────────────────────────────────
  - description: "Neovide: Fix <S-Space> and cmd+q → ZZ"
    manipulators:
      - type: basic
        from: { key_code: spacebar, modifiers: { mandatory: [shift] } }
        to:
          - key_code: f2
        conditions:
          - { type: frontmost_application_if, file_paths: ["[Nn]eovide"] }
      # cmd+q -> <Esc>ZZ (does not skip pre-quit triggers)
      - type: basic
        from: { key_code: q, modifiers: { mandatory: [command] } }
        to:
          # so cursor position and changes are saved
          - shell_command: |
              export PATH=/usr/local/lib:/usr/local/bin:/opt/homebrew/bin/:$PATH
              nvim --server "/tmp/nvim_server.pipe" --remote-send "<cmd>try|wqall|catch|qall|endtry<CR>"
        conditions:
          - { type: frontmost_application_if, file_paths: ["[Nn]eovide"] }
  #─────────────────────────────────────────────────────────────────────────────
  # switching via keyboard layout too laggy
  - description: "Grave ^ -> f1, and that in turn remapped in the app"
    manipulators:
      - type: basic
        from: { key_code: non_us_backslash }
        conditions:
          - { type: input_source_if, input_sources: [language: ^de$] }
          - type: frontmost_application_if
            file_paths:
              - ^/Applications/Obsidian\.app
              - "[Nn]eovide"
        to:
          - { key_code: f1 }
  #─────────────────────────────────────────────────────────────────────────────
  - description: "svim: shift-space to ctrl-s"
    manipulators:
      - type: basic
        from: { key_code: spacebar, modifiers: { mandatory: [shift] } }
        to:
          - { key_code: s, modifiers: [control] }
        conditions:
          - type: frontmost_application_if
            bundle_identifiers:
              - ^com\.brave\.Browser$
              - ^com\.vivaldi\.Vivaldi$
              - ^com\.tinyspeck\.slackmacgap$
              - ^com\.hnc\.Discord$
              - ^com\.apptorium\.SideNotes-paddle$
              - ^com\.mimestream\.Mimestream$
              - ^com\.github\.wez\.wezterm$
  #─────────────────────────────────────────────────────────────────────────────
  - description: "vim motions: special characters in US layout"
    manipulators:
      # ⚒️ {}@^~|: German to US layout for vim
      # Curly Brace {
      - type: basic
        from: { key_code: "8", modifiers: { mandatory: [option] } }
        conditions:
          - { type: input_source_if, input_sources: [language: ^de$] }
          - type: frontmost_application_if
            file_paths:
              - ^/Applications/Obsidian\.app
              - "[Nn]eovide"
        to:
          - select_input_source: { input_source_id: ^com\.apple\.keylayout\.US$ }
          - { key_code: vk_none, hold_down_milliseconds: 20 }
          - { key_code: open_bracket, modifiers: [shift] }
        to_after_key_up:
          - select_input_source: { input_source_id: ^com\.apple\.keylayout\.ABC-QWERTZ$ }
      # Curly Brace }
      - type: basic
        from: { key_code: "9", modifiers: { mandatory: [option] } }
        conditions:
          - { type: input_source_if, input_sources: [language: ^de$] }
          - type: frontmost_application_if
            file_paths:
              - ^/Applications/Obsidian\.app
              - "[Nn]eovide"
        to:
          - select_input_source: { input_source_id: ^com\.apple\.keylayout\.US$ }
          - { key_code: vk_none, hold_down_milliseconds: 20 }
          - { key_code: close_bracket, modifiers: [shift] }
        to_after_key_up:
          - select_input_source: { input_source_id: ^com\.apple\.keylayout\.ABC-QWERTZ$ }
      # at @
      - type: basic
        from: { key_code: l, modifiers: { mandatory: [option] } }
        conditions:
          - { type: input_source_if, input_sources: [language: ^de$] }
          - type: frontmost_application_if
            file_paths:
              - ^/Applications/Obsidian\.app
              - "[Nn]eovide"
        to:
          - { select_input_source: { input_source_id: ^com\.apple\.keylayout\.US$ } }
          - { key_code: vk_none, hold_down_milliseconds: 20 }
          - { key_code: "2", modifiers: [shift] }
        to_after_key_up:
          - select_input_source: { input_source_id: ^com\.apple\.keylayout\.ABC-QWERTZ$ }
